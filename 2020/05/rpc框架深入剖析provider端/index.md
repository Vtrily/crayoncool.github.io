# RPC工作原理分析Provider端


RPC Provider功能分析

<!--more-->
## Provider功能分析

队列/线程池 

超时丢弃：快速失败已经超时的请求，缓解队列堆积

优雅关闭

过载保护

### 线程池的分配

两种分配情况

1. 一个队列多个线程（1*64）

缺点：锁粒度过大，线程切换消耗资源

优点：对慢包的适应能力强，几乎没有影响

2. 多个队列一个线程（64*1）

缺点：对慢请求的适应能力差，容易造成堵塞

优点：没有竞争锁的开销

#### 队列数，线程池数如何选择？

通过压测进行测试

#### 超时丢弃处理逻辑

IO线程任务入队，工作线程从队列中拿任务，判断任务是否超时，超时丢弃，不超时调用service方法处理


#### 优雅关闭

发布代码时服务会重启，重启时服务端会通知客户端我需要重启，客户端就不发送新的请求到重启的结点，等队列中的任务处理完之后服务重启

方法：

1.返回数据中待关闭信息

有人调用的时候才会返回关闭信息
缺点：有的客户端可能接收不到关闭信息，因为客户端流量少，不会调用服务端

2.专门关闭协议通知调用方

#### 如何通知调用方？？ 

###### 优雅关闭Server端实现

监听关闭信号 kill -12

改变服务状态

通知客户端

##### 优雅关闭客户端实现

根据返回改变节点状态

节点探活


#### 过载保护

主动丢弃超出处理能力外的请求，不让请求进入队列或者丢弃原有队列中的任务

解决方法：马上扩容


### RPC高级功能

服务熔断

服务降级

限流

动态权重


1.什么是服务熔断？

当某服务出现不可用或超时的情况时，为了防止整个系统出现雪崩，暂时停止对该服务的调用

RPC客户端触发熔断，某一个时间范围内的失败占比超过设定值的时候触发熔断（Hystrix实际上就是又代理了一层调用，时间的滑动窗口）

2. 什么是降级？

熔断了之后需要做一些默认处理，这个称之为降级。核心数据不能做降级操作

3. 动态权重

为节点分配权重，逐步提高权重

权重是什么的权重？是服务端的权重，但是这个配置是在客户端配置的

但是在客户端配置权重会导致交流成本的增加

为什么服务端不能设置权重？

服务端设置权重的话会导致客户端无感知，并且还会造成二次请求分发，并不推荐

4.限流

限流是针对客户端做的，限流是针对集群做的

在发送端进行限流的操作，就不会发送请求到服务端




# RPC工作原理分析


RPC工作原理分析

<!--more-->
## RPC定义

RPC: 远程过程调用，像调用本地方法一样调用远程服务

## RPC的作用

组包与解包
数据发送与接收
提高开发效率
业务发展的产物

## RPC的核心组成

远程方法对象的代理
连接管理
序列化与反序列化
寻址与负载均衡

## RPC的调用方式

同步调用
异步调用

## RPC的调用过程

远程代理
序列化
网络传输
反序列化

client:创建连接，构造数据，网络传输
provider:等待连接，解析数据，获取数据，构造数据，网络传输
client:接收数据，解析数据

## 序列化协议

head+body
版本号+cmd+magic+bodylength+body
识别协议是否是你需要的，需要一个magic code

一次传输需要序列化两次，body序列化一次，对象序列化一次

请求先放到队列里，然后由另外的线程去实现，实现之后方法发到返回队列里，然后由IO线程进行返回。这个实现和mysql的多线程很相似


## 序列化与反序列化的实现方式

序列化

右移8*i位

反序列化

左移8*i位与0xff相与，最后或操作

校验包的完整性，头的长度，body的长度


RPC核心功能分析

Consumer核心功能：连接管理，负载均衡，请求里有，超时处理，健康检查

Provider核心功能：队列/线程池，超时丢弃，优雅关闭，过载保护

连接管理：初始化时机，连接数，心跳

负载均衡：轮训，随机，取模，带权重，一致性Hash


权重负载均衡设计

使用数组存放权重

路由功能设计

匹配规则
行为
链表



超时处理

工作线程阻塞通知：等待回包通知

超时逻辑

工作线程等待通知
数据返回终止等待
超时抛出异常

### RPC 

![client](/blog-img/RPC Client端.jpg)
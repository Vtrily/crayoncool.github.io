# mysql存储原理学习


MySQL存储原理深入剖析与技术分析

<!--more-->

本文主要从以下几个方面分析MySQL InnoDB存储引擎相关内容

- 数据存储原理
- 索引实现原理
- 内存管理
- 相关的使用优化

## 数据存储原理

mysql中数据的存储是按照页的方式进行存储的，也是InnoDB磁盘管理的最小单位。默认每页大小是16K（为什么页的大小默认是16K？-待研究），InnoDB存储引擎保证每一页至少有2条数据

首先我们来了解一下页的结构

页中包含了页头，虚记录，记录堆，Free Space，未分配空间，Slots，页尾等

- 页头占用了56个字节主要存储Slots的数量，页中记录数量，索引ID等信息。
- 虚记录分为最小虚记录和最大虚记录。
- 记录堆是实际存储行记录的内容。
- Free Space是个链表数据结构，在一条记录被删除后，该空间会被加入到空闲链表中。
- 页尾占8个字节，主要存储页面的校验信息。

### 页内记录维护

- 如何保证顺序？
- 插入策略？
- 页内查询规则

#### 如何保证顺序？

顺序性可以分为物理连续和逻辑连续

##### 物理连续

``` text
物理连续时需要频繁的移动数据，磁盘IO消耗大
```

##### 逻辑连续

``` text
逻辑连续使用指针保证逻辑连续
```

页间双向链表

页内单向链表

#### 插入策略

尽可能的利用空间的使用率，填补页内空洞

- 优先使用自由空间链表
- 其次使用未分配空间

#### 页内查询规则

遍历
二分查找

B+树索引本身并不能找到具体的一条记录，能找到的只是该记录所在的页。数据库把页载入内存后，利用Slots进行二分查找。

#### 变长的数据存储

每页默认16KB
每页最少有两条数据

- 单行最大8K

最多存储10个大字段

- 数据段最大768
- 超出部分存储在溢出页
- （768+20）* 10 < 8K

VARCHAR

- 1或2个字节描述字符长度
- 实际内容存储在长度字节之后

## 索引实现原理

- 聚簇索引
- 二级索引
- 联合索引

## 内存管理

## 相关的使用优化
# 注册中心分析上


注册中心分析

<!--more-->

# 注册中心主要功能

## 服务注册

路由信息，注册服务节点IP,端口号。服务信息：序列化协议，路由规则，节点权重

## 服务发现

1.启动拉取

2.通知回调

3.轮训拉取


## 健康检查

确保已注册节点健康度，能够及时准确剔除失效节点，保证服务发现正确性

### 失效原因

- 部署重启

- 服务假死

- 异常终止

### 解决方案

- 上报心跳

上报心跳的弊端是工作线程满的时候已经处理不过来了，心跳继续上报，可能会导致无效请求

- 服务探测

服务中新开一个接口专门用来探测

## 变更通知

当服务提供方节点发生变更时，注册中心应该能够第一时间把变更时间或变更后的数据推送到服务订阅方

## 注册中心设计

- 数据存储
- 超时处理

### 注册中心存储设计

- 注册数据组织
集群维度

节点维度

注册数据是以集群维度存储的

- 订阅数据组织

可以分成两个维度存储，一种是以消费者维度存储调用的列表，方便查看调用列表，用于服务治理

一种是以提供者维度存储订阅者列表，当提供方服务发生变更时方便用来通知订阅方

### 超时扫描

- 遍历扫描

- 动态分组

相同超时时间取模获取到相同的超时时间放到数组中的链表中

有一个问题就是超时时间不一致的话就不能用上述的方法


## 注册中心实现思考

自带存储，保证数据已执行

逻辑+配套存储

注册中心的复杂点就在于数据的存储和保证数据的一致性


## 节点变更通知

如何发送到指定节点？

使用gossip（八卦，谣言）协议

### gossip协议

-- 六度分离理论

-- 周期性散播消息

-- 随机选择N个节点散播

-- 散播不重复不回传